<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Mouth Chat Bot</title>
    <style>
        :root{--pri:#d40078;--pri-dark:#b80066;--light:#f8f9fa;--acc:#ff4da6;}
        body{font-family:Segoe UI,sans-serif;margin:0;}
        #floater{
            position:fixed;bottom:100px;right:30px;
            background:var(--pri);color:#fff;padding:10px 18px;
            border-radius:30px;font-size:14px;font-weight:500;
            box-shadow:0 4px 15px rgba(212,0,120,.4);
            animation:float 3s infinite ease-in-out;z-index:99998;
            pointer-events:none;opacity:0;transition:opacity .5s;
        }
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
        #toggle{
            position:fixed;bottom:20px;right:20px;width:60px;height:60px;
            background:var(--pri);color:#fff;border-radius:50%;
            display:flex;align-items:center;justify-content:center;
            font-size:28px;cursor:pointer;box-shadow:0 6px 20px rgba(212,0,120,.5);
            z-index:99999;transition:.3s;
        }
        #toggle:hover{transform:scale(1.1)}
        #chat{
            position:fixed;bottom:20px;right:20px;width:380px;max-width:90vw;
            background:#fff;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);
            z-index:99999;overflow:hidden;display:none;flex-direction:column;
        }
        #chat.open{display:flex}
        .hdr{
            background:linear-gradient(135deg,var(--pri),var(--acc));
            color:#fff;padding:16px;font-weight:600;font-size:18px;
            text-align:center;position:relative;
        }
        .cls{
            position:absolute;right:12px;top:12px;background:none;
            border:none;color:#fff;font-size:24px;cursor:pointer;
        }
        .body{flex:1;max-height:500px;overflow-y:auto;padding:16px;background:#fff;}
        .btn{
            display:block;width:100%;padding:14px;margin:8px 0;
            background:var(--light);border:2px solid #eee;border-radius:12px;
            text-align:left;font-size:15px;cursor:pointer;transition:.2s;
        }
        .btn:hover{background:#fdf2f8;border-color:var(--pri);transform:translateX(4px)}
        .btn.main{background:var(--pri);color:#fff;font-weight:600;border:none}
        .btn.main:hover{background:var(--pri-dark)}
        .prod{
            background:#f0e6ff;padding:12px;border-radius:10px;
            margin:10px 0;font-size:14px;border-left:4px solid var(--pri);
        }
        .qty-box{
            display:flex;align-items:center;margin:10px 0;
            background:#fff;border:2px solid #ddd;border-radius:10px;
            overflow:hidden;width:130px;
        }
        .qty-btn{
            background:#eee;color:#333;border:none;width:40px;height:40px;
            font-size:22px;font-weight:bold;cursor:pointer;transition:.2s;
        }
        .qty-btn:hover{background:#d40078;color:#fff}
        .qty-input{
            width:50px;text-align:center;border:none;font-size:16px;
            padding:10px 0;outline:none;font-weight:600;
        }
        .summary{font-weight:600;color:#333;margin:12px 0 8px;}
        .confirm-box{background:#fff9e6;padding:14px;border-radius:12px;border:2px solid #ffcc00;margin:12px 0;}
        .ai-response{background:#e6f3ff;padding:12px;border-radius:10px;margin:10px 0;border-left:4px solid #0066cc;}
        .loading{color:#666;font-style:italic;}
        input[type=text], input[type=email], input[type=tel]{
            width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:6px;font-size:14px;
        }
    </style>
</head>
<body>
<!-- Floating Message -->
<div id="floater"></div>
<!-- Toggle Button -->
<div id="toggle">Chat</div>
<!-- Chatbot -->
<div id="chat">
    <div class="hdr">Smart Mouth Chat Bot<button class="cls">x</button></div>
    <div class="body" id="chatBody"></div>
</div>
<script>
// === PRODUCT URLS & PRICES (UNCHANGED) ===
const productURLs = {
    "Badger Screw Starter Pack": "https://smartmouthtechnologies.com/?add-to-cart=2103&quantity=",
    "Badger Screw": "https://smartmouthtechnologies.com/?add-to-cart=1320&quantity=",
    "Long Straight": "https://smartmouthtechnologies.com/?add-to-cart=1986&quantity=",
    "Long Angled": "https://smartmouthtechnologies.com/?add-to-cart=1993&quantity=",
    "Short Straight": "https://smartmouthtechnologies.com/?add-to-cart=2042&quantity=",
    "Short Angled": "https://smartmouthtechnologies.com/?add-to-cart=2039&quantity=",
    "Crown Catcher": "https://smartmouthtechnologies.com/shop",
    "Beacon Body": "https://smartmouthtechnologies.com/?add-to-cart=1147&quantity="
};
const priceMap = {
    "Badger Screw Starter Pack": 2316.00,
    "Badger Screw": 180.00,
    "Long Straight": 179.00,
    "Long Angled": 79.00,
    "Short Straight": 179.00,
    "Short Angled": 79.00,
    "Crown Catcher": 10.00,
    "Beacon Body": 480.00
};
// === STATE ===
let state = {
    step: 'main',
    product: null,
    driverLength: null,
    driverAngle: null,
    quantity: 1,
    delivery: null
};
// === DOM ===
const chatBody = document.getElementById('chatBody');
const chat = document.getElementById('chat');
const toggle = document.getElementById('toggle');
const close = document.querySelector('.cls');
const floater = document.getElementById('floater');
toggle.onclick = () => { chat.classList.add('open'); render(); };
close.onclick = () => { chat.classList.remove('open'); };
// === FLOATING MESSAGES ===
const msgs = ["New AI Assistant!", "I can take care of your order", "Ask about WIB or Badger Screw"];
let i = 0;
function showFloat(){floater.textContent=msgs[i];floater.style.opacity=1;
    setTimeout(()=>{floater.style.opacity=0},3000);i=(i+1)%msgs.length;}
setInterval(showFloat,5000);showFloat();
// === RENDER ===
function render() {
    chatBody.innerHTML = '';
    if (state.step === 'main') showMainMenu();
    else if (state.step === 'product') showProductMenu();
    else if (state.step === 'driverLength') showDriverLength();
    else if (state.step === 'driverAngle') showDriverAngle();
    else if (state.step === 'delivery') showDelivery();
    else if (state.step === 'summary') showSummary();
    else if (state.step === 'confirm') showConfirm();
    else if (state.step === 'immediate') showContactForm('immediate');
    else if (state.step === 'agent') showContactForm('agent');
    else if (state.step === 'faq') showFAQ();
    else if (state.step === 'aiOther') showAIOther();
}
// === MAIN MENU ===
function showMainMenu() {
    chatBody.innerHTML = `
        <button class="btn main" onclick="goTo('product')">Orders</button>
        <button class="btn main" onclick="showInfo('Compatibility')">Compatibility</button>
        <button class="btn main" onclick="goTo('faq')">FAQ</button>
        <button class="btn main" onclick="goTo('aiOther')">Other (AI)</button>
        <button class="btn main" onclick="goTo('agent')">Connect to Agent</button>
    `;
}
// === CONTACT FORM (Immediate or Agent) ===
function showContactForm(type) {
    const title = type === 'immediate' ? 'Immediate Overnight Delivery' : 'Connect to Agent';
    const note = type === 'immediate' ? 'We will call you within 15 minutes.' : 'An agent will contact you shortly.';
    chatBody.innerHTML = `
        <div class="prod"><strong>${title}</strong><br>${note}</div>
        <input type="text" id="name" placeholder="Your Name" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="tel" id="cell" placeholder="Cell Number (e.g. 5551234567)" required>
        <button class="btn main" onclick="submitContact('${type}')">Submit</button>
        <button class="btn" onclick="goTo('main')">Cancel</button>
    `;
}
async function submitContact(type) {
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const cell = document.getElementById('cell').value.trim();
    if (!name || !email || !cell) {
        alert('Please fill all fields.');
        return;
    }

    // Determine context
    const isQuestion = type === 'agent' && state.step === 'aiOther';
    const isImmediate = type === 'immediate';
    const context = isQuestion 
        ? `AI Question: "${document.getElementById('aiInput')?.value || 'N/A'}"` 
        : (isImmediate ? "IMMEDIATE SHIPPING REQUEST" : "Connect to Agent");

    const subject = isImmediate 
        ? "URGENT: Immediate Overnight Order" 
        : (isQuestion ? "AI Question from Customer" : "Customer Wants Agent");

    const body = `
Name: ${name}
Email: ${email}
Cell: ${cell}

Context: ${context}

${isQuestion ? `Question: ${document.getElementById('aiInput').value}` : ''}
${isImmediate ? `Product: ${state.product || 'Not selected'}\nQuantity: ${state.quantity}` : ''}
`.trim();

    // === 1. SEND EMAIL VIA FREE WEB API (Maileroo) ===
    try {
        const emailResponse = await fetch('https://api.maileroo.com/v1/emails', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer YOUR_MAILEROO_KEY',  // Replace with your free key
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                from: { name: 'Smart Mouth Bot', email: 'noreply@yourdomain.com' },  // Use your email
                to: [{ name: 'Mishkat', email: 'mishkat1096@gmail.com' }],
                subject: subject,
                html: `<p><strong>New Request:</strong></p><p>${body.replace(/\n/g, '<br>')}</p>`
            })
        });
        if (!emailResponse.ok) throw new Error('Email API failed');
    } catch (e) {
        // FALLBACK: Free Formspree Web Form (No Key Needed)
        const formData = new FormData();
        formData.append('subject', subject);
        formData.append('message', body);
        formData.append('_next', 'https://smartmouthtechnologies.com/thanks');  // Redirect after submit

        fetch('YOUR_FORMSPREE_ENDPOINT', {  // Replace with https://formspree.io/f/abc123
            method: 'POST',
            body: formData
        }).catch(err => console.log('Form fallback failed:', err));
    }

    // === 2. SEND SMS VIA FREE WEB API (Textbelt – 1 Free/Day) ===
    try {
        const smsResponse = await fetch('https://textbelt.com/text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                phone: '+13133983577',  // Full number with country code
                message: `${name} → ${isImmediate ? "IMMEDIATE SHIPPING" : isQuestion ? "QUESTION" : "AGENT"} | Call: ${cell} | ${context.substring(0, 100)}...`,
                key: 'textbelt'  // Free quota key (1/day)
            })
        });
        const smsData = await smsResponse.json();
        if (!smsData.success) throw new Error('SMS quota exceeded');
    } catch (e) {
        // FALLBACK: Alert with copy-paste (if quota hit)
        alert(`SMS sent! (Quota may be hit – Text: ${name} → ${context.substring(0, 50)} to 313-398-3577)`);
    }

    // === 3. SHOW CONFIRMATION ===
    chatBody.innerHTML = `
        <div class="prod" style="background:#e6ffe6;border-left:4px solid #28a745;">
            <strong>Request Sent Successfully!</strong><br>
            ${isImmediate ? "Immediate shipping" : isQuestion ? "Your question" : "Agent connection"} confirmed.<br>
            Email & SMS notifications sent. We'll contact you within 15 minutes.
        </div>
        <button class="btn main" onclick="restart()">New Order</button>
    `;
}
// === DELIVERY (Immediate → Form) ===
function showDelivery() {
    chatBody.innerHTML = `
        <div class="prod">Selected: <strong>${state.product}</strong></div>
        <div class="summary">Choose Delivery</div>
        <button class="btn" onclick="goTo('immediate')">Immediate (Overnight)</button>
        <button class="btn" onclick="chooseDelivery('regular')">Regular (2–3 day)</button>
        <button class="btn" onclick="goTo(state.driverLength ? 'driverAngle' : 'product')">Back</button>
    `;
}
// === AI OTHER (UNCHANGED) ===
function showAIOther() {
    chatBody.innerHTML = `
        <div class="summary">Ask AI Anything</div>
        <div class="prod">Examples: "Best driver for implants?", "Crown Catcher uses?"</div>
        <input type="text" id="aiInput" placeholder="Your question..." style="width:100%;padding:12px;margin:8px 0;border:1px solid #ccc;border-radius:6px;font-size:14px;">
        <button class="btn main" onclick="handleAIQuestion()">Send to AI</button>
        <button class="btn" onclick="goTo('main')">Back to Menu</button>
        <div id="aiResponse"></div>
    `;
}
async function handleAIQuestion() {
    const input = document.getElementById('aiInput');
    const q = input.value.trim();
    if (!q) return alert('Please enter a question.');

    input.disabled = true;
    const resp = document.getElementById('aiResponse');
    resp.innerHTML = '<div class="prod loading">Mia is thinking...</div>';

    try {
        // Fixed: Use relative URL so it works on 127.0.0.1, localhost, or any host
        const response = await fetch('/rag', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: q })
        });

        if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
        }

        const data = await response.json();

        // Make URLs clickable + preserve line breaks
        const answerWithLinks = (data.answer || "I couldn't find an answer.")
            .replace(/\n/g, '<br>')
            .replace(/(https?:\/\/[^\s<>"']+)/g, 
                '<a href="$1" target="_blank" style="color:#0066cc; text-decoration:underline; font-weight:500;">$1</a>'
            );

        resp.innerHTML = `
            <div class="ai-response">
                <strong>Mia:</strong> ${answerWithLinks}
                <div style="margin-top:12px; font-size:13px;">
                    <button class="btn" onclick="goTo('product')" style="width:auto; margin:4px; padding:8px 14px;">Order Product</button>
                    <button class="btn" onclick="document.getElementById('aiInput').value=''; document.getElementById('aiInput').focus();" 
                            style="width:auto; margin:4px; padding:8px 14px;">Ask Another</button>
                </div>
            </div>`;
    } catch (e) {
        console.error("AI fetch error:", e);
        resp.innerHTML = `
            <div class="ai-response" style="color:#d40078;">
                Oops! Can't reach Mia right now.<br>
                <small>Check if the server is running on port 5000</small>
            </div>`;
    }

    input.value = '';
    input.disabled = false;
    input.focus();
}
// === REST OF ORIGINAL CODE (UNCHANGED) ===
function showProductMenu() {
    chatBody.innerHTML = `
        <button class="btn prod" onclick="selectProduct('Badger Screw Starter Pack')">Starter Pack</button>
        <button class="btn prod" onclick="selectProduct('Badger Screw')">Badger Screw (10 per pack)</button>
        <button class="btn prod" onclick="goTo('driverLength')">Drivers</button>
        <button class="btn prod" onclick="selectProduct('Beacon Body')">Beacon Body (6 per pack)</button>
        <button class="btn prod" onclick="selectProduct('Crown Catcher')">Crown Catcher</button>
        <button class="btn" onclick="goTo('main')">Back</button>
    `;
}
function showDriverLength() {
    chatBody.innerHTML = `
        <div class="prod">Choose Driver Length</div>
        <button class="btn" onclick="selectDriverLength('Long')">Long</button>
        <button class="btn" onclick="selectDriverLength('Short')">Short</button>
        <button class="btn" onclick="goTo('product')">Back</button>
    `;
}
function selectDriverLength(len) { state.driverLength = len; goTo('driverAngle'); }
function showDriverAngle() {
    chatBody.innerHTML = `
        <div class="prod">Choose Angle</div>
        <button class="btn" onclick="selectDriverAngle('Straight')">Straight</button>
        <button class="btn" onclick="selectDriverAngle('Angled')">Angled</button>
        <button class="btn" onclick="goTo('driverLength')">Back</button>
    `;
}
function selectDriverAngle(angle) { state.driverAngle = angle; state.product = `${state.driverLength} ${angle}`; goTo('delivery'); }
function selectProduct(name) { state.product = name; state.driverLength = null; state.driverAngle = null; goTo('delivery'); }
function chooseDelivery(type) { state.delivery = type; if (type === 'immediate') goTo('immediate'); else goTo('summary'); }
function showImmediate() { } // Now handled by showContactForm
function showSummary() {
    const price = priceMap[state.product] || 0;
    const total = price * state.quantity;
    chatBody.innerHTML = `
        <div class="summary">Order Summary</div>
        <div class="prod">
            <strong>${state.product}</strong><br>
            Unit Price: $${price.toFixed(2)}
        </div>
        <div style="margin:12px 0;">
            <label><strong>Quantity:</strong></label>
            <div class="qty-box">
                <button class="qty-btn" onclick="changeQty(-1)">-</button>
                <input type="number" class="qty-input" id="qtyInput" value="${state.quantity}" min="1">
                <button class="qty-btn" onclick="changeQty(1)">+</button>
            </div>
        </div>
        <div class="prod">
            <strong>Total: $${total.toFixed(2)}</strong>
        </div>
        <button class="btn main" onclick="goTo('confirm')">Order Now</button>
        <button class="btn" onclick="goTo('delivery')">Back</button>
    `;
    document.getElementById('qtyInput').onchange = (e) => {
        let val = parseInt(e.target.value);
        if (isNaN(val) || val < 1) val = 1;
        state.quantity = val;
        render();
    };
}
function changeQty(delta) { state.quantity = Math.max(1, state.quantity + delta); render(); }
function showConfirm() {
    const price = priceMap[state.product] || 0;
    const total = price * state.quantity;
    chatBody.innerHTML = `
        <div class="confirm-box">
            <strong>Confirm Your Order</strong><br><br>
            <strong>Product:</strong> ${state.product}<br>
            <strong>Quantity:</strong> ${state.quantity}<br>
            <strong>Total:</strong> $${total.toFixed(2)}<br><br>
            <em>Click Confirm to add to cart.</em>
        </div>
        <button class="btn main" onclick="addToCart()">Confirm</button>
        <button class="btn" onclick="goTo('summary')">Back</button>
    `;
}
// Put this in the page that opens the checkout and does add-to-cart.
// ----------------------------------------------------
// 1. Helper – waits for cart count to increase
// ----------------------------------------------------
function waitForCartChange(oldCount, timeout = 8000) {
    return new Promise((resolve, reject) => {
        const start = Date.now();
        const interval = setInterval(() => {
            const badge = document.querySelector('.cart-count, .woocommerce-cart-count, .cart-items, .mini-cart-items');
            const newCount = badge ? parseInt(badge.textContent?.trim() || '0', 10) : 0;

            if (newCount > oldCount) {
                clearInterval(interval);
                resolve(newCount);
            } else if (Date.now() - start > timeout) {
                clearInterval(interval);
                reject(new Error('Cart did not update'));
            }
        }, 300);
    });
}

// ----------------------------------------------------
// 1. Helper – simple delay
// ----------------------------------------------------
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ----------------------------------------------------
// 2. FIXED addToCart() – Direct to Checkout
// ----------------------------------------------------
// ----------------------------------------------------
// 1. Simple delay helper
// ----------------------------------------------------
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ----------------------------------------------------
// 2. NEW addToCart() – keeps chat, opens links after 20 s
// ----------------------------------------------------
async function addToCart() {
    const baseURL = productURLs[state.product];
    if (!baseURL) {
        alert("Product not available for online ordering.");
        return;
    }

    const qty = state.quantity;
    const addToCartURL = baseURL + qty;               // e.g. ?add-to-cart=1986&quantity=3
    const checkoutURL   = "https://smartmouthtechnologies.com/checkout/";

    // 1. Show the “working” message inside the chat
    chatBody.innerHTML = `
        <div class="prod" style="background:#fff9e6;border-left:4px solid #ffcc00;">
            <strong>We are working on your order…</strong><br>
            ${qty} × ${state.product}<br>
            <em>Please wait while we add the item to your cart.</em>
        </div>
    `;

    // 2. Wait 20 seconds (you can change the value if you want)
    await delay(10_000);

    // 3. Open the add‑to‑cart link in a new tab
    const addTab = window.open(addToCartURL, "_blank");
    
    // 4. Small extra delay so the add‑to‑cart AJAX finishes before checkout opens
    await delay(1500);

    // 5. Open checkout in another new tab
    const checkoutTab = window.open(checkoutURL, "_blank");

    // 6. Final success message (still inside the chat)
    chatBody.innerHTML = `
        <div class="prod" style="background:#e6ffe6;border-left:4px solid #28a745;">
            <strong>Added to Cart!</strong><br>
            ${qty} × ${state.product}<br>
            <em>Checkout tab opened – complete your purchase!</em>
        </div>
        <button class="btn main" onclick="restart()">New Order</button>
        <button class="btn" onclick="window.open('https://smartmouthtechnologies.com/cart/', '_blank')">
            View Cart
        </button>
    `;

    // 7. Focus the checkout tab (optional – brings it to front)
    setTimeout(() => {
        if (checkoutTab && !checkoutTab.closed) checkoutTab.focus();
    }, 300);
}
function goTo(step) { state.step = step; render(); }
function restart() {
    state = { step: 'main', product: null, driverLength: null, driverAngle: null, quantity: 1, delivery: null };
    render();
}
function showInfo(title) {
    const info = {
        "Compatibility": "Compatible with 20+ MUAs: 3i®, Adin®, Astra®, Biohorizons®, Nobel Biocare®, Straumann® and more.<br>Badger Screw: M1.4 thread, 0.048″ hex driver."
    };
    chatBody.innerHTML = `<div class="prod">${info[title]}</div>
        <button class="btn main" onclick="restart()">Back to Menu</button>`;
}
function showFAQ() {
    chatBody.innerHTML = `
        <div class="prod">
            WIB: 10 tokens = 1 case (6 simulations)<br>
            Badger Screw: 136N clamping force<br>
            Sterilization: Autoclave safe
        </div>
        <button class="btn main" onclick="restart()">Back to Menu</button>
    `;
}
render();
</script>
</body>
</html>